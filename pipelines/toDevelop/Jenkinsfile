pipeline {
    agent any

    environment {
        ORACLE_CONTAINER = "oracle-db"
        SQLCL_PATH       = "/opt/sqlcl/bin/sql"
        DB_CONN_STR      = "localhost:1522/FREEPDB1"
        BUILD_DIR        = "/tmp/apex_project_desa"
        DB_USR           = "DESA_SCHEMA"
    }

    stages {
        stage('Initialize') {
            steps {
                // deleteDir()
                checkout scm
            }
        }

        stage('Static Analysis') {
            steps {
                script {
                    def scannerHome = tool 'sonar-scanner'
                    withSonarQubeEnv('sonarqube') {
                        sh "${scannerHome}/bin/sonar-scanner \
                        -Dsonar.projectKey=web-app-feature \
                        -Dsonar.sources=."
                    }
                }
            }
        }

        stage('Generate Artifact') {
            environment {
                DB = credentials('apex-desa-credential')
            }
            steps {
                script {
                    echo "=== Generando Artefacto para DESA ==="
                    sh """
                        tar -cf /tmp/project_desa.tar -C ${WORKSPACE} .
                        docker exec -u root ${ORACLE_CONTAINER} mkdir -p ${BUILD_DIR}
                        docker cp /tmp/project_desa.tar ${ORACLE_CONTAINER}:/tmp/
                        docker exec -u root ${ORACLE_CONTAINER} bash -c "
                            rm -rf ${BUILD_DIR}/* ${BUILD_DIR}/.* 2>/dev/null || true
                            tar -xf /tmp/project_desa.tar -C ${BUILD_DIR}
                            chown -R oracle: ${BUILD_DIR}
                            rm /tmp/project_desa.tar
                        "
                        rm /tmp/project_desa.tar
                    """

                    sh """
                        docker exec -u oracle -e DB_USR="\$DB_USR" -e DB_PSW="\$DB_PSW" ${ORACLE_CONTAINER} bash -c "
                            cd ${BUILD_DIR}
                            ${SQLCL_PATH} \"\$DB_USR\"/\"\$DB_PSW\"@${DB_CONN_STR} <<EOF
                            WHENEVER SQLERROR EXIT SQL.SQLCODE
                            WHENEVER OSERROR EXIT FAILURE
                            project stage
                            project gen-artifact -name app-desa -version ${BUILD_NUMBER}
                            exit
EOF
                        "
                    """
                    sh "mkdir -p artifact && docker cp ${ORACLE_CONTAINER}:${BUILD_DIR}/artifact/. artifact/"
                }
            }
        }

        stage('Deploy to DESA') {
            environment {
                DB = credentials('apex-desa-credential')
            }
            steps {
                script {
                    echo "=== Desplegando a DESA (Esquema: ${DB_USR}) ==="
                    def artifactFile = sh(script: "ls artifact/*.zip | head -n 1", returnStdout: true).trim()
                    sh "docker cp ${artifactFile} ${ORACLE_CONTAINER}:/tmp/deploy_app_desa.zip"
                    sh """
                        docker exec -u oracle -e DB_USR="\$DB_USR" -e DB_PSW="\$DB_PSW" ${ORACLE_CONTAINER} bash -c "
                            cd ${BUILD_DIR}
                            ${SQLCL_PATH} \"\$DB_USR\"/\"\$DB_PSW\"@${DB_CONN_STR} <<EOF
                            WHENEVER SQLERROR EXIT SQL.SQLCODE
                            WHENEVER OSERROR EXIT FAILURE
                            project config set -name sqlcl.connectionName -value develop
                            project deploy -file /tmp/deploy_app_desa.zip
                            exit
EOF
                        "
                    """
                }
            }
        }
    }

    post {
        always {
            archiveArtifacts artifacts: 'artifact/*.zip', allowEmptyArchive: true
            sh "docker exec -u root ${ORACLE_CONTAINER} rm -rf ${BUILD_DIR} /tmp/deploy_app_desa.zip || true"
        }
    }
}
