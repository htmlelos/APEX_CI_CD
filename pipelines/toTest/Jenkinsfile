pipeline {
    agent any
    
    triggers {
        githubPush()
    }

    options {
        skipDefaultCheckout()
        timeout(time: 30, unit: 'MINUTES')
        buildDiscarder(logRotator(numToKeepStr: '10'))
    }

    environment {
        ORACLE_CONTAINER = "oracle-db"
        SQLCL_PATH       = "/opt/sqlcl/bin/sql"
        DB_CONN_STR      = "localhost:1521/FREEPDB1"
        BUILD_DIR        = "/tmp/apex_project_test"
        DB_USR           = "TEST_SCHEMA"
        MAIL_RECIPIENTS  = "sergiolucero73@gmail.com, slucero@runaid.com.ar"
    }

    stages {
        stage('Initialize') {
            steps {
                deleteDir()
                checkout scm
            }
        }

        stage('Obtain Artifact') {
            steps {
                script {
                    sh "mkdir -p artifact"
                    copyArtifacts(
                        projectName: 'APEX-Deploy-DESA',
                        selector: lastSuccessful(),
                        filter: 'artifact/*.zip',
                        target: 'artifact',
                        flatten: true
                    )
                }
            }
        }

        stage('Deploy to TEST') {
            environment {
                DB = credentials('apex-test-credential')
            }
            steps {
                script {
                    def artifactFile = sh(script: "ls artifact/*.zip | head -n 1", returnStdout: true).trim()
                    
                    echo "=== Preparando Contexto en Contenedor ==="
                    sh """
                        tar --exclude='./artifact' -cf /tmp/project_context.tar -C ${WORKSPACE} .
                        docker exec -u root ${ORACLE_CONTAINER} mkdir -p ${BUILD_DIR}
                        docker cp /tmp/project_context.tar ${ORACLE_CONTAINER}:/tmp/
                        docker exec -u root ${ORACLE_CONTAINER} bash -c "
                            rm -rf ${BUILD_DIR}/* ${BUILD_DIR}/.* 2>/dev/null || true
                            tar -xf /tmp/project_context.tar -C ${BUILD_DIR}
                            chown -R oracle: ${BUILD_DIR}
                            rm /tmp/project_context.tar
                        "
                        rm /tmp/project_context.tar
                        docker cp ${artifactFile} ${ORACLE_CONTAINER}:/tmp/deploy_app.zip
                    """

                    echo "=== Ejecutando Despliegue con SQLcl ==="
                    sh """
                        docker exec -u oracle -e DB_USR="\$DB_USR" -e DB_PSW="\$DB_PSW" ${ORACLE_CONTAINER} bash -c '
                            cd ${BUILD_DIR}
                            
                            echo "=== Generando liquibase.properties ==="
                            sed "s/\\\\r//" dist/utils/properties/test.properties | grep "=" > liquibase.properties
                            
                            ${SQLCL_PATH} "\$DB_USR"/"\$DB_PSW"@${DB_CONN_STR} <<EOF
WHENEVER SQLERROR EXIT SQL.SQLCODE
WHENEVER OSERROR EXIT FAILURE
project config set -name sqlcl.connectionName -value test
project deploy -file /tmp/deploy_app.zip
exit
EOF
                        '
                    """
                }
            }
        }
    }
    
    post {
        always {
            sh "docker exec -u root ${ORACLE_CONTAINER} rm -rf ${BUILD_DIR} || true"
        }
    }
}
